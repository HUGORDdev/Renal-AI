name: Model Training & Deployment Pipeline

on:
  workflow_dispatch: # Permet le lancement manuel depuis l'interface GitHub
  push:
    paths:
      - 'models/**'
      - 'backend/**' # D√©clenche aussi pour les changements backend (ex: requirements.txt)
      - '.github/workflows/model_pipeline.yml'
    branches:
      - main

jobs:
  train-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r backend/requirements.txt
        pip install huggingface_hub joblib scikit-learn pandas numpy xgboost

    # √âtape 3 : R√©-entra√Ænement (Simulation ou R√©el)
    # Ici, on suppose que vous avez un script qui g√©n√®re les .joblib dans backend/model_assets
    - name: Train Model
      run: |
        # python models/train.py 
        # Pour l'instant on ne fait qu'afficher car le script n'est pas encore l√†
        echo "Training model..." 

    # √âtape 4 : Upload vers Hugging Face
    - name: Upload to Hugging Face
      env:
        HF_TOKEN: ${{ secrets.HF_TOKEN }}
      run: |
        python scripts/upload_models.py

    # √âtape 5 : Trigger Vercel Redeploy (Backend)
    - name: Trigger Vercel Deploy
      if: success()
      env:
        VERCEL_DEPLOY_HOOK: ${{ secrets.VERCEL_DEPLOY_HOOK }}
      run: |
        if [ -n "$VERCEL_DEPLOY_HOOK" ]; then
          echo "üöÄ Triggering Vercel deployment..."
          curl -X POST "$VERCEL_DEPLOY_HOOK"
        else
          echo "‚ö†Ô∏è VERCEL_DEPLOY_HOOK secret is missing. Skipping auto-deploy."
        fi
